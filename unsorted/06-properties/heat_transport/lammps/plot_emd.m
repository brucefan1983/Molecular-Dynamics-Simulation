clear;close all; font_size=15;

file ='hac.txt';

% Nc = ????????????????????
[Tstart Nc] = textread(file, '%n%n', 1, 'headerlines', 3);  
[index TimeDelta Ncount c_1 c_2 c_3] ...
    = textread(file, '%n%n%n%n%n%n', 'headerlines', Nc+4, 'emptyvalue', 0);
Ns = TimeDelta(3,1) - TimeDelta(2, 1);  % Ns = ????????
hac = [index TimeDelta Ncount c_1 c_2 c_3];  
nall = length(hac) / (Nc+1);
clear index TimeDelta Ncount c_1 c_2 c_3;
for i=1:nall
    hac((i-1)*Nc+1, :) = [];
end

%????MD????????????????
dt = 0.01;      % ???????????????? ps 
T = 60;         % ?????? K
kB = 8.625e-5;  % ???????????????????? eV/K
a = 5.4;        % ???????????????? A
V = (4*a)^3;    % ????
scale = 1.6e+3 / (kB*T*T*V) * (Ns*dt); % ????????

% ????????????????
M = size(hac, 1) / Nc 

% ??????????
t = (1 : Nc) * Ns * dt; % correlation time

% ????????????????????????????????????
hac = reshape(mean(hac(:, 4:6), 2), Nc, M);
rtc =  scale * cumtrapz(hac);

% ????????????????????????????
hac_ave = mean(hac, 2);
rtc_ave = mean(rtc, 2);

% ??????????????????????
figure
for n = 1 : M
    plot(t, hac(:, n) / hac(1, n), 'color', 0.5 * [1 1 1]);
    hold on;
end
plot(t, hac_ave / hac_ave(1), 'linewidth', 3);
xlabel('Correlation Time (ps)', 'fontsize', font_size);
ylabel('HCACF (Normalized)', 'fontsize', font_size);
set(gca,'fontsize', font_size);

% ??????????????
figure
for n = 1 : M
    plot(t, rtc, 'color', 0.5 * [1 1 1]);
    hold on;
end
plot(t, rtc_ave, 'linewidth', 3);
xlabel('Correlation Time (ps)', 'fontsize', font_size);
ylabel('\kappa (W/mK)', 'fontsize', font_size);
ylim([0, 0.6]);
set(gca,'fontsize', font_size);

% ????????
kappa_converged = mean(rtc(Nc/2+1 : Nc, :)); %????????????????
kappa_average = mean(kappa_converged)
kappa_error = std(kappa_converged) / sqrt(M)
